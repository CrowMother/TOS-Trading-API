
from Modules import universal
from Modules import logger
from Modules import secretkeys
from Modules import data as Data
import time
from flask import Flask, request, jsonify
import requests


app = Flask(__name__)
streamer = None
SERVER_URL = secretkeys.get_url()
print(SERVER_URL)

def remove_specific_characters(input_string, characters_to_remove):
    return ''.join([char for char in input_string if char not in characters_to_remove])

def parse_message(message):
    try:
        chars_to_remove = "\[]}{\"\'"
        message = remove_specific_characters(message, chars_to_remove)
        mes_parts = message.split(",")
        #print(f"\nparts\n{mes_parts}")
        return mes_parts
    except Exception as e:
        print(f"can't parse: {e}")

def datafy(parsed_message):

    data = {'time': universal.time_stamp()}

    # Process each string in the parsed message
    for item in parsed_message:
        try:
            # Split on ':' and strip the quotes and whitespace
            key, value = item.split(':')
            key = key.strip().strip('"')
            value = value.strip().strip('"')
            data[key] = value
        except ValueError as e:
            universal.error_code(f"Skipping invalid format: {item}. Error: {str(e)}")
    
    return data


def set_streamer(client):
    global streamer
    streamer = client.stream

def my_handler(data):
    universal.okay_code(data)
    logger.write_to_log(data)
    
    #parse data that we need
    data = Data.data_in(data)

    logger.write_to_log(f"Post data Processing: {data}")
    # Ensure that send_trade is called correctly within the application context\
    return


# Tracking for stock pricing of AMD and intel
def start_level_one_equity_stream(client):
    streamer.start(my_handler)
    client.stream.send(client.stream.level_one_equities("AMD,INTC", "0,1,2,3,4,5,6,7,8"))
    streamer.stop()

# Tracking of account data 
def start_account_tracking(client):
    if client is None:
        universal.error_code("Error Client is a None Type")
    else:
        streamer.start(my_handler)
        client.stream.send(client.stream.account_activity("Account Activity", "0,1,2,3,4"))
    
    
def send_trade_data_in_background(data):
    with app.app_context():
        try:

            print(f"sending data to: {SERVER_URL}")
            response = requests.post(f"{SERVER_URL}", json=data)
            response.raise_for_status()  # Handle HTTP errors
            return {'status': 'data sent', 'response': response.json()}
        except requests.exceptions.RequestException as e:
            universal.error_code(f"Connection with server lost! {str(e)}")
            return {'status': 'error', 'message': str(e)}

    
#send heart beat notification to server
@app.route('/send-heart', methods=["GET"])
def send_heart(data):
    global SERVER_URL
    # Post request to the other server
    try:
        
        time.sleep(30)
        response = requests.post(SERVER_URL, json=data)
        # Return the response from the other server
        return jsonify({'status': 'data sent', 'response': response.json()})
    except requests.exceptions.RequestException as e:
        # Handle any exceptions that occur during the POST request
        universal.error_code("connection with server lost!")
        
        #after error code figure out design for what to do with the data that can't be sent
        return jsonify({'status': 'error', 'message': str(e)})

if __name__ == '__main__':
    # Start the Flask app
     app.run(host="0.0.0.0", port=80, debug=True)
     




def send_test_trade_order():
    testList = [
        '{"service":"ACCT_ACTIVITY","timestamp":1726847587056,"command":"SUBS","content":[{"1":"54661285","2":"OrderCreated","3":"{\"SchwabOrderID\":\"1001657905188\",\"AccountNumber\":\"54661285\",\"BaseEvent\":{\"EventType\":\"OrderCreated\",\"OrderCreatedEventEquityOrder\":{\"EventType\":\"OrderCreated\",\"Order\":{\"SchwabOrderID\":\"1001657905188\",\"AccountNumber\":\"54661285\",\"Order\":{\"AccountInfo\":{\"AccountNumber\":\"54661285\",\"AccountBranch\":\"WT\",\"CustomerOrFirmCode\":\"CustomerOrFirmCode_Customer\",\"OrderPlacementCustomerID\":\"353286754\",\"AccountState\":\"MO\",\"AccountTypeCode\":\"Customer\"},\"ClientChannelInfo\":{\"ClientProductCode\":\"M1\",\"EventUserID\":\"O1XX\",\"EventUserType\":\"Client\"},\"LifecycleCreatedTimestamp\":{\"DateTimeString\":\"2024-09-20 11:53:06.929\"},\"LifecycleSchwabOrderID\":\"1001657905188\",\"EntryTimestamp\":{\"DateTimeString\":\"2024-09-20 11:53:06.929\"},\"ExpiryTimeStamp\":{\"DateTimeString\":\"2024-09-20\"},\"AutoConfirm\":true,\"PlanSubmitDate\":{\"DateTimeString\":\"2024-09-20\"},\"SourceOMS\":\"ngOMS\",\"FirmID\":\"CHAS\",\"OrderAccount\":\"TDAAccount\",\"AssetOrderEquityOrderLeg\":{\"OrderInstruction\":{\"HandlingInstructionCode\":\"AutomatedExecutionNoIntervention\",\"ExecutionStrategy\":{\"Type\":\"ES_Limit\",\"LimitExecutionStrategy\":{\"Type\":\"ES_Limit\",\"LimitPrice\":{\"lo\":\"1520000\",\"signScale\":12},\"LimitPriceUnitCode\":\"Units\"}},\"PreferredRoute\":{},\"EquityOrderInstruction\":{}},\"CommissionInfo\":{\"EstimatedOrderQuantity\":{\"lo\":\"2000000\",\"signScale\":12},\"EstimatedPrincipalAmount\":{\"lo\":\"304000000\",\"signScale\":13},\"EstimatedCommissionAmount\":{\"lo\":\"1300000\",\"signScale\":12}},\"AssetType\":\"MajorAssetType_EquityOption\",\"TimeInForce\":\"Day\",\"OrderTypeCode\":\"Limit\",\"OrderLegs\":[{\"LegID\":\"1001657905188\",\"LegParentSchwabOrderID\":\"1001657905188\",\"Quantity\":{\"lo\":\"2000000\",\"signScale\":12},\"QuantityUnitCodeType\":\"SharesOrUnits\",\"LeavesQuantity\":{\"lo\":\"2000000\",\"signScale\":12},\"BuySellCode\":\"Buy\",\"Security\":{\"SchwabSecurityID\":\"102000669\",\"Symbol\":\"SPY   240927P00560000\",\"UnderlyingSymbol\":\"SPY\",\"MajorAssetType\":\"MajorAssetType_EquityOption\",\"PrimaryMarketSymbol\":\"SPY   240927P00560000\",\"ShortDescriptionText\":\"SPDR S\\u0026P 500 09/27/2024 $560 Put\",\"ShortName\":\"SPDR S\\u0026P 500 09/27/2024 $560 Put\",\"CUSIP\":\"0SPY..UR40560000\",\"OptionsSecurityInfo\":{\"PutCallCode\":\"Put\",\"UnderlyingSchwabSecurityID\":\"1281357639\",\"StrikePrice\":{\"lo\":\"560000000\",\"signScale\":12},\"OptionExpiryDate\":{\"DateTimeString\":\"2024-09-27 00:00:00.000\"}}},\"QuoteOnOrderAcceptance\":{\"Ask\":{\"lo\":\"1510000\",\"signScale\":12},\"AskSize\":{\"lo\":\"236\"},\"Bid\":{\"lo\":\"1490000\",\"signScale\":12},\"BidSize\":{\"lo\":\"159\"},\"QuoteTimestamp\":{\"DateTimeString\":\"2024-09-20 11:53:06.929\"},\"Symbol\":\"SPY   240927P00560000\",\"QuoteTypeCode\":\"Mark\",\"Mid\":{\"lo\":\"1500000\",\"signScale\":12},\"SchwabOrderID\":\"1001657905188\",\"OptionsQuote\":{\"PutCallCode\":\"Put\"}},\"LegClientRequestInfo\":{\"SecurityId\":\"SPY   240927P00560000\",\"SecurityIdTypeCd\":\"Symbol\"},\"AccountingRuleCode\":\"Cash\",\"EstimatedNetAmount\":{\"lo\":\"305300000\",\"signScale\":13},\"EstimatedPrincipalAmnt\":{\"lo\":\"304000000\",\"signScale\":13},\"EquityOrderLeg\":{\"EquityOptionsOrderLeg\":{\"OpenClosePositionCode\":\"PC_Open\"}}}],\"OrderCapacityCode\":\"OC_Agency\",\"SettlementType\":\"SettlementType_Regular\",\"Rule80ACode\":73,\"SolicitedCode\":\"Unsolicited\",\"TradeTag\":\"API_TOS:TRADE_ALL\",\"EquityOrder\":{\"TradingSessionCodeOnOrder\":\"REG\"}}}}}}}","seq":48,"key":"Account Activity"},{"1":"54661285","2":"OrderAccepted","3":"{\"SchwabOrderID\":\"1001657905188\",\"AccountNumber\":\"54661285\",\"BaseEvent\":{\"EventType\":\"OrderAccepted\",\"OrderAcceptedEvent\":{\"EventType\":\"OrderAccepted\",\"CreatedTimeStamp\":{\"DateTimeString\":\"2024-09-20 11:53:06.929\"},\"ExpiryTimeStamp\":{\"DateTimeString\":\"2024-09-20\"},\"Status\":\"Open\",\"TradingSessionCodeOnOrderEntry\":\"REG\",\"QuoteOnOrderEntry\":[{\"Ask\":{\"lo\":\"1510000\",\"signScale\":12},\"AskSize\":{\"lo\":\"236\"},\"Bid\":{\"lo\":\"1490000\",\"signScale\":12},\"BidSize\":{\"lo\":\"159\"},\"QuoteTimestamp\":{\"DateTimeString\":\"2024-09-20 11:53:06.929\"},\"Symbol\":\"SPY   240927P00560000\",\"QuoteTypeCode\":\"Mark\",\"Mid\":{\"lo\":\"1500000\",\"signScale\":12},\"SchwabOrderID\":\"1001657905188\",\"OptionsQuote\":{\"PutCallCode\":\"Put\"}}]}}}","seq":49,"key":"Account Activity"}]}',
        '{"service":"ACCT_ACTIVITY","timestamp":1726847588066,"command":"SUBS","content":[{"1":"54661285","2":"ExecutionRequested","3":"{\"SchwabOrderID\":\"1001657905188\",\"AccountNumber\":\"54661285\",\"BaseEvent\":{\"EventType\":\"ExecutionRequested\",\"ExecutionRequestedEventRoutedInfo\":{\"EventType\":\"ExecutionRequested\",\"RouteSequenceNumber\":1,\"RouteInfo\":{\"RouteName\":\"MORGAN_OPT_F1_J2\",\"RouteSequenceNumber\":1,\"RoutedExecutionTimestamp\":{\"DateTimeString\":\"2024-09-20 11:53:06.965\"},\"Quote\":{\"Ask\":{\"lo\":\"1510000\",\"signScale\":12},\"AskSize\":{\"lo\":\"236\"},\"Bid\":{\"lo\":\"1490000\",\"signScale\":12},\"BidSize\":{\"lo\":\"159\"},\"QuoteTimestamp\":{\"DateTimeString\":\"2024-09-20 11:53:06.929\"},\"Symbol\":\"SPY   240927P00560000\",\"QuoteTypeCode\":\"Mark\",\"Mid\":{\"lo\":\"1500000\",\"signScale\":12},\"SchwabOrderID\":\"1001657905188\",\"OptionsQuote\":{\"PutCallCode\":\"Put\"}},\"RouteRequestedType\":\"New\",\"RoutedQuantity\":{\"lo\":\"2000000\",\"signScale\":12},\"RoutedPrice\":{\"lo\":\"1520000\",\"signScale\":12},\"RouteStatus\":\"RouteCreated\",\"ClientOrderID\":\"1001657905188.1\",\"RoutedTime\":{\"DateTimeString\":\"2024-09-20 11:53:06.965\"},\"RouteTimeInForce\":\"Day\",\"RouteAcknowledgmentTimeStamp\":{}},\"RouteRequestedBy\":\"RR_Broker\",\"LegId\":\"1001657905188\"}}}","seq":50,"key":"Account Activity"},{"1":"54661285","2":"ExecutionRequestCreated","3":"{\"SchwabOrderID\":\"1001657905188\",\"AccountNumber\":\"54661285\",\"BaseEvent\":{\"EventType\":\"ExecutionRequestCreated\",\"ExecutionRequestCreatedEvent\":{\"EventType\":\"ExecutionRequestCreated\",\"LegId\":\"1001657905188\",\"RouteName\":\"MORGAN_OPT_F1_J2\",\"RouteRequestType\":\"New\",\"RouteSequenceNumber\":1,\"RouteRequestedBy\":\"RR_Broker\",\"RouteStatus\":\"RouteFixAcknowledged\",\"SenderCompID\":\"SCHWAB\",\"RoutedTime\":{\"DateTimeString\":\"2024-09-20 11:53:06.995\"},\"ClientOrderID\":\"1001657905188.1\"}}}","seq":51,"key":"Account Activity"},{"1":"54661285","2":"ExecutionRequestCompleted","3":"{\"SchwabOrderID\":\"1001657905188\",\"AccountNumber\":\"54661285\",\"BaseEvent\":{\"EventType\":\"ExecutionRequestCompleted\",\"ExecutionRequestCompletedEvent\":{\"EventType\":\"ExecutionRequestCompleted\",\"LegId\":\"1001657905188\",\"ResponseType\":\"Accepted\",\"ExecutionTime\":{\"DateTimeString\":\"2024-09-20 11:53:07.053\"},\"RouteSequenceNumber\":1,\"RouteStatus\":\"RouteVenueAccepted\",\"RouteAcknowledgmentTimeStamp\":{\"DateTimeString\":\"2024-09-20 11:53:07.022\"},\"ClientOrderID\":\"1001657905188.1\"}}}","seq":52,"key":"Account Activity"},{"1":"54661285","2":"OrderFillCompleted","3":"{\"SchwabOrderID\":\"1001657905188\",\"AccountNumber\":\"54661285\",\"BaseEvent\":{\"EventType\":\"OrderFillCompleted\",\"OrderFillCompletedEventOrderLegQuantityInfo\":{\"EventType\":\"OrderFillCompleted\",\"LegId\":\"1001657905188\",\"LegStatus\":\"LegClosed\",\"QuantityInfo\":{\"ExecutionID\":\"20240920-EST-ngOMS-13303091620\",\"CumulativeQuantity\":{\"lo\":\"2000000\",\"signScale\":12},\"LeavesQuantity\":{\"signScale\":12},\"AveragePrice\":{\"lo\":\"1500000\",\"signScale\":12}},\"PriceImprovement\":{\"lo\":\"2000000\",\"signScale\":12},\"LegSubStatus\":\"LegSubStatusFilled\",\"ExecutionInfo\":{\"ExecutionSequenceNumber\":1,\"ExecutionId\":\"20240920-EST-ngOMS-13303091620\",\"VenueExecutionID\":\"aTU2Ex-XRn2uN3dXOz8mBwA1\",\"Exchange\":\"CBOE\",\"ExecutionQuantity\":{\"lo\":\"2000000\",\"signScale\":12},\"ExecutionPrice\":{\"lo\":\"1500000\",\"signScale\":12},\"ExecutionTimeStamp\":{\"DateTimeString\":\"2024-09-20 11:53:07.154\"},\"ExecutionTransType\":\"Fill\",\"ExecutionCapacityCode\":\"Agency\",\"RouteName\":\"MORGAN_OPT_F1_J2\",\"RouteSequenceNumber\":1,\"VenuExecutionTimeStamp\":{\"DateTimeString\":\"2024-09-20 11:53:07.124\"},\"ReportingCapacityCode\":\"RC_Agency\",\"ActualChargedCommissionAmount\":{\"lo\":\"1300000\",\"signScale\":12},\"AsOfTimeStamp\":{},\"ActualChargedFeesCommissionAndTax\":{\"StateTaxWithholding\":{\"signScale\":12},\"FederalTaxWithholding\":{\"signScale\":12},\"SECFees\":{\"signScale\":12},\"ORF\":{\"lo\":\"20000\",\"signScale\":12},\"FTT\":{\"signScale\":12},\"TaxWithholding1446\":{\"signScale\":12},\"GoodsAndServicesTax\":{\"signScale\":12},\"IOF\":{\"signScale\":12},\"TAF\":{\"signScale\":12},\"CommissionAmount\":{\"lo\":\"1300000\",\"signScale\":12}},\"ClientOrderID\":\"1001657905188.1\"},\"OrderInfoForTransactionPosting\":{\"LimitPrice\":{\"lo\":\"1520000\",\"signScale\":12},\"OrderTypeCode\":\"Limit\",\"OpenClosePositionCode\":\"PC_Open\",\"BuySellCode\":\"Buy\",\"Quantity\":{\"lo\":\"2000000\",\"signScale\":12},\"StopPrice\":{},\"Symbol\":\"SPY   240927P00560000\",\"SchwabSecurityID\":\"102000669\",\"SolicitedCode\":\"Unsolicited\",\"AccountingRuleCode\":\"Cash\",\"SettlementType\":\"SettlementType_Regular\",\"OrderCreatedUserID\":\"O1XX\",\"OrderCreatedUserType\":\"Venue\",\"ClientProductCode\":\"N1\"}}}}","seq":53,"key":"Account Activity"}]}',
        #'{"service":"ACCT_ACTIVITY","timestamp":1726847725336,"command":"SUBS","content":[{"1":"54661285","2":"OrderCreated","3":"{\"SchwabOrderID\":\"1001657905371\",\"AccountNumber\":\"54661285\",\"BaseEvent\":{\"EventType\":\"OrderCreated\",\"OrderCreatedEventEquityOrder\":{\"EventType\":\"OrderCreated\",\"Order\":{\"SchwabOrderID\":\"1001657905371\",\"AccountNumber\":\"54661285\",\"Order\":{\"AccountInfo\":{\"AccountNumber\":\"54661285\",\"AccountBranch\":\"WT\",\"CustomerOrFirmCode\":\"CustomerOrFirmCode_Customer\",\"OrderPlacementCustomerID\":\"353286754\",\"AccountState\":\"MO\",\"AccountTypeCode\":\"Customer\"},\"ClientChannelInfo\":{\"ClientProductCode\":\"M1\",\"EventUserID\":\"O1XX\",\"EventUserType\":\"Client\"},\"LifecycleCreatedTimestamp\":{\"DateTimeString\":\"2024-09-20 11:55:25.217\"},\"LifecycleSchwabOrderID\":\"1001657905371\",\"EntryTimestamp\":{\"DateTimeString\":\"2024-09-20 11:55:25.217\"},\"ExpiryTimeStamp\":{\"DateTimeString\":\"2024-09-20\"},\"AutoConfirm\":true,\"PlanSubmitDate\":{\"DateTimeString\":\"2024-09-20\"},\"SourceOMS\":\"ngOMS\",\"FirmID\":\"CHAS\",\"OrderAccount\":\"TDAAccount\",\"AssetOrderEquityOrderLeg\":{\"OrderInstruction\":{\"HandlingInstructionCode\":\"AutomatedExecutionNoIntervention\",\"ExecutionStrategy\":{\"Type\":\"ES_Limit\",\"LimitExecutionStrategy\":{\"Type\":\"ES_Limit\",\"LimitPrice\":{\"lo\":\"1370000\",\"signScale\":12},\"LimitPriceUnitCode\":\"Units\"}},\"PreferredRoute\":{},\"EquityOrderInstruction\":{}},\"CommissionInfo\":{\"EstimatedOrderQuantity\":{\"lo\":\"2000000\",\"signScale\":12},\"EstimatedPrincipalAmount\":{\"lo\":\"274000000\",\"signScale\":12},\"EstimatedCommissionAmount\":{\"lo\":\"1300000\",\"signScale\":12}},\"AssetType\":\"MajorAssetType_EquityOption\",\"TimeInForce\":\"Day\",\"OrderTypeCode\":\"Limit\",\"OrderLegs\":[{\"LegID\":\"1001657905371\",\"LegParentSchwabOrderID\":\"1001657905371\",\"Quantity\":{\"lo\":\"2000000\",\"signScale\":12},\"QuantityUnitCodeType\":\"SharesOrUnits\",\"LeavesQuantity\":{\"lo\":\"2000000\",\"signScale\":12},\"BuySellCode\":\"Sell\",\"Security\":{\"SchwabSecurityID\":\"102000669\",\"Symbol\":\"SPY   240927P00560000\",\"UnderlyingSymbol\":\"SPY\",\"MajorAssetType\":\"MajorAssetType_EquityOption\",\"PrimaryMarketSymbol\":\"SPY   240927P00560000\",\"ShortDescriptionText\":\"SPDR S\\u0026P 500 09/27/2024 $560 Put\",\"ShortName\":\"SPDR S\\u0026P 500 09/27/2024 $560 Put\",\"CUSIP\":\"0SPY..UR40560000\",\"OptionsSecurityInfo\":{\"PutCallCode\":\"Put\",\"UnderlyingSchwabSecurityID\":\"1281357639\",\"StrikePrice\":{\"lo\":\"560000000\",\"signScale\":12},\"OptionExpiryDate\":{\"DateTimeString\":\"2024-09-27 00:00:00.000\"}}},\"QuoteOnOrderAcceptance\":{\"Ask\":{\"lo\":\"1390000\",\"signScale\":12},\"AskSize\":{\"lo\":\"188\"},\"Bid\":{\"lo\":\"1380000\",\"signScale\":12},\"BidSize\":{\"lo\":\"78\"},\"QuoteTimestamp\":{\"DateTimeString\":\"2024-09-20 11:55:25.217\"},\"Symbol\":\"SPY   240927P00560000\",\"QuoteTypeCode\":\"Mark\",\"Mid\":{\"lo\":\"1385000\",\"signScale\":13},\"SchwabOrderID\":\"1001657905371\",\"OptionsQuote\":{\"PutCallCode\":\"Put\"}},\"LegClientRequestInfo\":{\"SecurityId\":\"SPY   240927P00560000\",\"SecurityIdTypeCd\":\"Symbol\"},\"AccountingRuleCode\":\"Cash\",\"EstimatedNetAmount\":{\"lo\":\"272700000\",\"signScale\":12},\"EstimatedPrincipalAmnt\":{\"lo\":\"274000000\",\"signScale\":12},\"EquityOrderLeg\":{\"EquityOptionsOrderLeg\":{\"OpenClosePositionCode\":\"PC_Close\"}}}],\"OrderCapacityCode\":\"OC_Agency\",\"SettlementType\":\"SettlementType_Regular\",\"Rule80ACode\":73,\"SolicitedCode\":\"Unsolicited\",\"TradeTag\":\"API_TOS:TRADE_ALL\",\"EquityOrder\":{\"TradingSessionCodeOnOrder\":\"REG\"}}}}}}}","seq":54,"key":"Account Activity"},{"1":"54661285","2":"OrderAccepted","3":"{\"SchwabOrderID\":\"1001657905371\",\"AccountNumber\":\"54661285\",\"BaseEvent\":{\"EventType\":\"OrderAccepted\",\"OrderAcceptedEvent\":{\"EventType\":\"OrderAccepted\",\"CreatedTimeStamp\":{\"DateTimeString\":\"2024-09-20 11:55:25.217\"},\"ExpiryTimeStamp\":{\"DateTimeString\":\"2024-09-20\"},\"Status\":\"Open\",\"TradingSessionCodeOnOrderEntry\":\"REG\",\"QuoteOnOrderEntry\":[{\"Ask\":{\"lo\":\"1390000\",\"signScale\":12},\"AskSize\":{\"lo\":\"188\"},\"Bid\":{\"lo\":\"1380000\",\"signScale\":12},\"BidSize\":{\"lo\":\"78\"},\"QuoteTimestamp\":{\"DateTimeString\":\"2024-09-20 11:55:25.217\"},\"Symbol\":\"SPY   240927P00560000\",\"QuoteTypeCode\":\"Mark\",\"Mid\":{\"lo\":\"1385000\",\"signScale\":13},\"SchwabOrderID\":\"1001657905371\",\"OptionsQuote\":{\"PutCallCode\":\"Put\"}}]}}}","seq":55,"key":"Account Activity"},{"1":"54661285","2":"ExecutionRequested","3":"{\"SchwabOrderID\":\"1001657905371\",\"AccountNumber\":\"54661285\",\"BaseEvent\":{\"EventType\":\"ExecutionRequested\",\"ExecutionRequestedEventRoutedInfo\":{\"EventType\":\"ExecutionRequested\",\"RouteSequenceNumber\":1,\"RouteInfo\":{\"RouteName\":\"DASH_OPT_F1_J1\",\"RouteSequenceNumber\":1,\"RoutedExecutionTimestamp\":{\"DateTimeString\":\"2024-09-20 11:55:25.249\"},\"Quote\":{\"Ask\":{\"lo\":\"1390000\",\"signScale\":12},\"AskSize\":{\"lo\":\"188\"},\"Bid\":{\"lo\":\"1380000\",\"signScale\":12},\"BidSize\":{\"lo\":\"78\"},\"QuoteTimestamp\":{\"DateTimeString\":\"2024-09-20 11:55:25.217\"},\"Symbol\":\"SPY   240927P00560000\",\"QuoteTypeCode\":\"Mark\",\"Mid\":{\"lo\":\"1385000\",\"signScale\":13},\"SchwabOrderID\":\"1001657905371\",\"OptionsQuote\":{\"PutCallCode\":\"Put\"}},\"RouteRequestedType\":\"New\",\"RoutedQuantity\":{\"lo\":\"2000000\",\"signScale\":12},\"RoutedPrice\":{\"lo\":\"1370000\",\"signScale\":12},\"RouteStatus\":\"RouteCreated\",\"ClientOrderID\":\"1001657905371.1\",\"RoutedTime\":{\"DateTimeString\":\"2024-09-20 11:55:25.249\"},\"RouteTimeInForce\":\"Day\",\"RouteAcknowledgmentTimeStamp\":{}},\"RouteRequestedBy\":\"RR_Broker\",\"LegId\":\"1001657905371\"}}}","seq":56,"key":"Account Activity"}]}]'
        #'{"service":"ACCT_ACTIVITY","timestamp":1726847726345,"command":"SUBS","content":[{"1":"54661285","2":"ExecutionRequestCreated","3":"{\"SchwabOrderID\":\"1001657905371\",\"AccountNumber\":\"54661285\",\"BaseEvent\":{\"EventType\":\"ExecutionRequestCreated\",\"ExecutionRequestCreatedEvent\":{\"EventType\":\"ExecutionRequestCreated\",\"LegId\":\"1001657905371\",\"RouteName\":\"DASH_OPT_F1_J1\",\"RouteRequestType\":\"New\",\"RouteSequenceNumber\":1,\"RouteRequestedBy\":\"RR_Broker\",\"RouteStatus\":\"RouteFixAcknowledged\",\"SenderCompID\":\"SCHWABTDAMOFP1\",\"RoutedTime\":{\"DateTimeString\":\"2024-09-20 11:55:25.271\"},\"ClientOrderID\":\"1001657905371.1\"}}}","seq":57,"key":"Account Activity"},{"1":"54661285","2":"ExecutionRequestCompleted","3":"{\"SchwabOrderID\":\"1001657905371\",\"AccountNumber\":\"54661285\",\"BaseEvent\":{\"EventType\":\"ExecutionRequestCompleted\",\"ExecutionRequestCompletedEvent\":{\"EventType\":\"ExecutionRequestCompleted\",\"LegId\":\"1001657905371\",\"ResponseType\":\"Accepted\",\"ExchangeOrderID\":\"7800110211545\",\"ExecutionTime\":{\"DateTimeString\":\"2024-09-20 11:55:25.343\"},\"RouteSequenceNumber\":1,\"RouteStatus\":\"RouteVenueAccepted\",\"RouteAcknowledgmentTimeStamp\":{\"DateTimeString\":\"2024-09-20 11:55:25.311\"},\"ClientOrderID\":\"1001657905371.1\"}}}","seq":58,"key":"Account Activity"},{"1":"54661285","2":"OrderFillCompleted","3":"{\"SchwabOrderID\":\"1001657905371\",\"AccountNumber\":\"54661285\",\"BaseEvent\":{\"EventType\":\"OrderFillCompleted\",\"OrderFillCompletedEventOrderLegQuantityInfo\":{\"EventType\":\"OrderFillCompleted\",\"LegId\":\"1001657905371\",\"LegStatus\":\"LegClosed\",\"QuantityInfo\":{\"ExecutionID\":\"20240920-EST-ngOMS-13303091717\",\"CumulativeQuantity\":{\"lo\":\"2000000\",\"signScale\":12},\"LeavesQuantity\":{\"signScale\":12},\"AveragePrice\":{\"lo\":\"1390000\",\"signScale\":12}},\"PriceImprovement\":{\"lo\":\"2000000\",\"signScale\":12},\"LegSubStatus\":\"LegSubStatusFilled\",\"ExecutionInfo\":{\"ExecutionSequenceNumber\":1,\"ExecutionId\":\"20240920-EST-ngOMS-13303091717\",\"VenueExecutionID\":\"7800645283800\",\"Exchange\":\"CBOE\",\"ExecutionQuantity\":{\"lo\":\"2000000\",\"signScale\":12},\"ExecutionPrice\":{\"lo\":\"1390000\",\"signScale\":12},\"ExecutionTimeStamp\":{\"DateTimeString\":\"2024-09-20 11:55:25.461\"},\"ExecutionTransType\":\"Fill\",\"ExecutionCapacityCode\":\"Agency\",\"RouteName\":\"DASH_OPT_F1_J1\",\"RouteSequenceNumber\":1,\"VenuExecutionTimeStamp\":{\"DateTimeString\":\"2024-09-20 11:55:25.428\"},\"ReportingCapacityCode\":\"RC_Agency\",\"ActualChargedCommissionAmount\":{\"lo\":\"1300000\",\"signScale\":12},\"AsOfTimeStamp\":{},\"ActualChargedFeesCommissionAndTax\":{\"StateTaxWithholding\":{\"signScale\":12},\"FederalTaxWithholding\":{\"signScale\":12},\"SECFees\":{\"lo\":\"10000\",\"signScale\":12},\"ORF\":{\"lo\":\"20000\",\"signScale\":12},\"FTT\":{\"signScale\":12},\"TaxWithholding1446\":{\"signScale\":12},\"GoodsAndServicesTax\":{\"signScale\":12},\"IOF\":{\"signScale\":12},\"TAF\":{\"lo\":\"10000\",\"signScale\":12},\"CommissionAmount\":{\"lo\":\"1300000\",\"signScale\":12}},\"ClientOrderID\":\"1001657905371.1\"},\"OrderInfoForTransactionPosting\":{\"LimitPrice\":{\"lo\":\"1370000\",\"signScale\":12},\"OrderTypeCode\":\"Limit\",\"OpenClosePositionCode\":\"PC_Close\",\"BuySellCode\":\"Sell\",\"Quantity\":{\"lo\":\"2000000\",\"signScale\":12},\"StopPrice\":{},\"Symbol\":\"SPY   240927P00560000\",\"SchwabSecurityID\":\"102000669\",\"SolicitedCode\":\"Unsolicited\",\"AccountingRuleCode\":\"Cash\",\"SettlementType\":\"SettlementType_Regular\",\"OrderCreatedUserID\":\"O1XX\",\"OrderCreatedUserType\":\"Venue\",\"ClientProductCode\":\"N1\"}}}}","seq":59,"key":"Account Activity"}]}',
        '{"service":"ACCT_ACTIVITY","timestamp":1726850946047,"command":"SUBS","content":[{"1":"54661285","2":"OrderCreated","3":"{\"SchwabOrderID\":\"1001659308472\",\"AccountNumber\":\"54661285\",\"BaseEvent\":{\"EventType\":\"OrderCreated\",\"OrderCreatedEventEquityOrder\":{\"EventType\":\"OrderCreated\",\"Order\":{\"SchwabOrderID\":\"1001659308472\",\"AccountNumber\":\"54661285\",\"Order\":{\"AccountInfo\":{\"AccountNumber\":\"54661285\",\"AccountBranch\":\"WT\",\"CustomerOrFirmCode\":\"CustomerOrFirmCode_Customer\",\"OrderPlacementCustomerID\":\"353286754\",\"AccountState\":\"MO\",\"AccountTypeCode\":\"Customer\"},\"ClientChannelInfo\":{\"ClientProductCode\":\"M1\",\"EventUserID\":\"O1XX\",\"EventUserType\":\"Client\"},\"LifecycleCreatedTimestamp\":{\"DateTimeString\":\"2024-09-20 12:49:05.923\"},\"LifecycleSchwabOrderID\":\"1001659308472\",\"EntryTimestamp\":{\"DateTimeString\":\"2024-09-20 12:49:05.923\"},\"ExpiryTimeStamp\":{\"DateTimeString\":\"2024-09-20\"},\"AutoConfirm\":true,\"PlanSubmitDate\":{\"DateTimeString\":\"2024-09-20\"},\"SourceOMS\":\"ngOMS\",\"FirmID\":\"CHAS\",\"OrderAccount\":\"TDAAccount\",\"AssetOrderEquityOrderLeg\":{\"OrderInstruction\":{\"HandlingInstructionCode\":\"AutomatedExecutionNoIntervention\",\"ExecutionStrategy\":{\"Type\":\"ES_Limit\",\"LimitExecutionStrategy\":{\"Type\":\"ES_Limit\",\"LimitPrice\":{\"lo\":\"1700000\",\"signScale\":12},\"LimitPriceUnitCode\":\"Units\"}},\"PreferredRoute\":{},\"EquityOrderInstruction\":{}},\"CommissionInfo\":{\"EstimatedOrderQuantity\":{\"lo\":\"1000000\",\"signScale\":12},\"EstimatedPrincipalAmount\":{\"lo\":\"170000000\",\"signScale\":13},\"EstimatedCommissionAmount\":{\"lo\":\"650000\",\"signScale\":12}},\"AssetType\":\"MajorAssetType_EquityOption\",\"TimeInForce\":\"Day\",\"OrderTypeCode\":\"Limit\",\"OrderLegs\":[{\"LegID\":\"1001659308472\",\"LegParentSchwabOrderID\":\"1001659308472\",\"Quantity\":{\"lo\":\"1000000\",\"signScale\":12},\"QuantityUnitCodeType\":\"SharesOrUnits\",\"LeavesQuantity\":{\"lo\":\"1000000\",\"signScale\":12},\"BuySellCode\":\"Buy\",\"Security\":{\"SchwabSecurityID\":\"101968678\",\"Symbol\":\"AAPL  240927C00235000\",\"UnderlyingSymbol\":\"AAPL\",\"MajorAssetType\":\"MajorAssetType_EquityOption\",\"PrimaryMarketSymbol\":\"AAPL  240927C00235000\",\"ShortDescriptionText\":\"APPLE INC 09/27/2024 $235 Call\",\"ShortName\":\"APPLE INC 09/27/2024 $235 Call\",\"CUSIP\":\"0AAPL.IR40235000\",\"OptionsSecurityInfo\":{\"PutCallCode\":\"Call\",\"UnderlyingSchwabSecurityID\":\"1973757747\",\"StrikePrice\":{\"lo\":\"235000000\",\"signScale\":12},\"OptionExpiryDate\":{\"DateTimeString\":\"2024-09-27 00:00:00.000\"}}},\"QuoteOnOrderAcceptance\":{\"Ask\":{\"lo\":\"1700000\",\"signScale\":12},\"AskSize\":{\"lo\":\"5\"},\"Bid\":{\"lo\":\"1680000\",\"signScale\":12},\"BidSize\":{\"lo\":\"422\"},\"QuoteTimestamp\":{\"DateTimeString\":\"2024-09-20 12:49:05.923\"},\"Symbol\":\"AAPL  240927C00235000\",\"QuoteTypeCode\":\"Mark\",\"Mid\":{\"lo\":\"1690000\",\"signScale\":12},\"SchwabOrderID\":\"1001659308472\",\"OptionsQuote\":{\"PutCallCode\":\"Call\"}},\"LegClientRequestInfo\":{\"SecurityId\":\"AAPL  240927C00235000\",\"SecurityIdTypeCd\":\"Symbol\"},\"AccountingRuleCode\":\"Cash\",\"EstimatedNetAmount\":{\"lo\":\"170650000\",\"signScale\":13},\"EstimatedPrincipalAmnt\":{\"lo\":\"170000000\",\"signScale\":13},\"EquityOrderLeg\":{\"EquityOptionsOrderLeg\":{\"OpenClosePositionCode\":\"PC_Open\"}}}],\"OrderCapacityCode\":\"OC_Agency\",\"SettlementType\":\"SettlementType_Regular\",\"Rule80ACode\":73,\"SolicitedCode\":\"Unsolicited\",\"TradeTag\":\"API_TOS:TRADE_ALL\",\"EquityOrder\":{\"TradingSessionCodeOnOrder\":\"REG\"}}}}}}}","seq":109,"key":"Account Activity"},{"1":"54661285","2":"OrderAccepted","3":"{\"SchwabOrderID\":\"1001659308472\",\"AccountNumber\":\"54661285\",\"BaseEvent\":{\"EventType\":\"OrderAccepted\",\"OrderAcceptedEvent\":{\"EventType\":\"OrderAccepted\",\"CreatedTimeStamp\":{\"DateTimeString\":\"2024-09-20 12:49:05.923\"},\"ExpiryTimeStamp\":{\"DateTimeString\":\"2024-09-20\"},\"Status\":\"Open\",\"TradingSessionCodeOnOrderEntry\":\"REG\",\"QuoteOnOrderEntry\":[{\"Ask\":{\"lo\":\"1700000\",\"signScale\":12},\"AskSize\":{\"lo\":\"5\"},\"Bid\":{\"lo\":\"1680000\",\"signScale\":12},\"BidSize\":{\"lo\":\"422\"},\"QuoteTimestamp\":{\"DateTimeString\":\"2024-09-20 12:49:05.923\"},\"Symbol\":\"AAPL  240927C00235000\",\"QuoteTypeCode\":\"Mark\",\"Mid\":{\"lo\":\"1690000\",\"signScale\":12},\"SchwabOrderID\":\"1001659308472\",\"OptionsQuote\":{\"PutCallCode\":\"Call\"}}]}}}","seq":110,"key":"Account Activity"}]}',
        '{"service":"ACCT_ACTIVITY","timestamp":1726850947056,"command":"SUBS","content":[{"1":"54661285","2":"ExecutionRequested","3":"{\"SchwabOrderID\":\"1001659308472\",\"AccountNumber\":\"54661285\",\"BaseEvent\":{\"EventType\":\"ExecutionRequested\",\"ExecutionRequestedEventRoutedInfo\":{\"EventType\":\"ExecutionRequested\",\"RouteSequenceNumber\":1,\"RouteInfo\":{\"RouteName\":\"DASH_OPT_F1_J1\",\"RouteSequenceNumber\":1,\"RoutedExecutionTimestamp\":{\"DateTimeString\":\"2024-09-20 12:49:05.959\"},\"Quote\":{\"Ask\":{\"lo\":\"1700000\",\"signScale\":12},\"AskSize\":{\"lo\":\"5\"},\"Bid\":{\"lo\":\"1680000\",\"signScale\":12},\"BidSize\":{\"lo\":\"422\"},\"QuoteTimestamp\":{\"DateTimeString\":\"2024-09-20 12:49:05.923\"},\"Symbol\":\"AAPL  240927C00235000\",\"QuoteTypeCode\":\"Mark\",\"Mid\":{\"lo\":\"1690000\",\"signScale\":12},\"SchwabOrderID\":\"1001659308472\",\"OptionsQuote\":{\"PutCallCode\":\"Call\"}},\"RouteRequestedType\":\"New\",\"RoutedQuantity\":{\"lo\":\"1000000\",\"signScale\":12},\"RoutedPrice\":{\"lo\":\"1700000\",\"signScale\":12},\"RouteStatus\":\"RouteCreated\",\"ClientOrderID\":\"1001659308472.1\",\"RoutedTime\":{\"DateTimeString\":\"2024-09-20 12:49:05.959\"},\"RouteTimeInForce\":\"Day\",\"RouteAcknowledgmentTimeStamp\":{}},\"RouteRequestedBy\":\"RR_Broker\",\"LegId\":\"1001659308472\"}}}","seq":111,"key":"Account Activity"},{"1":"54661285","2":"ExecutionRequestCreated","3":"{\"SchwabOrderID\":\"1001659308472\",\"AccountNumber\":\"54661285\",\"BaseEvent\":{\"EventType\":\"ExecutionRequestCreated\",\"ExecutionRequestCreatedEvent\":{\"EventType\":\"ExecutionRequestCreated\",\"LegId\":\"1001659308472\",\"RouteName\":\"DASH_OPT_F1_J1\",\"RouteRequestType\":\"New\",\"RouteSequenceNumber\":1,\"RouteRequestedBy\":\"RR_Broker\",\"RouteStatus\":\"RouteFixAcknowledged\",\"SenderCompID\":\"SCHWABTDAMOFP1\",\"RoutedTime\":{\"DateTimeString\":\"2024-09-20 12:49:05.988\"},\"ClientOrderID\":\"1001659308472.1\"}}}","seq":112,"key":"Account Activity"},{"1":"54661285","2":"ExecutionRequestCompleted","3":"{\"SchwabOrderID\":\"1001659308472\",\"AccountNumber\":\"54661285\",\"BaseEvent\":{\"EventType\":\"ExecutionRequestCompleted\",\"ExecutionRequestCompletedEvent\":{\"EventType\":\"ExecutionRequestCompleted\",\"LegId\":\"1001659308472\",\"ResponseType\":\"Accepted\",\"ExchangeOrderID\":\"200096977015\",\"ExecutionTime\":{\"DateTimeString\":\"2024-09-20 12:49:06.087\"},\"RouteSequenceNumber\":1,\"RouteStatus\":\"RouteVenueAccepted\",\"RouteAcknowledgmentTimeStamp\":{\"DateTimeString\":\"2024-09-20 12:49:06.056\"},\"ClientOrderID\":\"1001659308472.1\"}}}","seq":113,"key":"Account Activity"},{"1":"54661285","2":"OrderFillCompleted","3":"{\"SchwabOrderID\":\"1001659308472\",\"AccountNumber\":\"54661285\",\"BaseEvent\":{\"EventType\":\"OrderFillCompleted\",\"OrderFillCompletedEventOrderLegQuantityInfo\":{\"EventType\":\"OrderFillCompleted\",\"LegId\":\"1001659308472\",\"LegStatus\":\"LegClosed\",\"QuantityInfo\":{\"ExecutionID\":\"20240920-EST-ngOMS-13304116286\",\"CumulativeQuantity\":{\"lo\":\"1000000\",\"signScale\":12},\"LeavesQuantity\":{\"signScale\":12},\"AveragePrice\":{\"lo\":\"1700000\",\"signScale\":12}},\"PriceImprovement\":{\"signScale\":12},\"LegSubStatus\":\"LegSubStatusFilled\",\"ExecutionInfo\":{\"ExecutionSequenceNumber\":1,\"ExecutionId\":\"20240920-EST-ngOMS-13304116286\",\"VenueExecutionID\":\"200551658919\",\"Exchange\":\"CBOE\",\"ExecutionQuantity\":{\"lo\":\"1000000\",\"signScale\":12},\"ExecutionPrice\":{\"lo\":\"1700000\",\"signScale\":12},\"ExecutionTimeStamp\":{\"DateTimeString\":\"2024-09-20 12:49:06.201\"},\"ExecutionTransType\":\"Fill\",\"ExecutionCapacityCode\":\"Agency\",\"RouteName\":\"DASH_OPT_F1_J1\",\"RouteSequenceNumber\":1,\"VenuExecutionTimeStamp\":{\"DateTimeString\":\"2024-09-20 12:49:06.168\"},\"ReportingCapacityCode\":\"RC_Agency\",\"ActualChargedCommissionAmount\":{\"lo\":\"650000\",\"signScale\":12},\"AsOfTimeStamp\":{},\"ActualChargedFeesCommissionAndTax\":{\"StateTaxWithholding\":{\"signScale\":12},\"FederalTaxWithholding\":{\"signScale\":12},\"SECFees\":{\"signScale\":12},\"ORF\":{\"lo\":\"10000\",\"signScale\":12},\"FTT\":{\"signScale\":12},\"TaxWithholding1446\":{\"signScale\":12},\"GoodsAndServicesTax\":{\"signScale\":12},\"IOF\":{\"signScale\":12},\"TAF\":{\"signScale\":12},\"CommissionAmount\":{\"lo\":\"650000\",\"signScale\":12}},\"ClientOrderID\":\"1001659308472.1\"},\"OrderInfoForTransactionPosting\":{\"LimitPrice\":{\"lo\":\"1700000\",\"signScale\":12},\"OrderTypeCode\":\"Limit\",\"OpenClosePositionCode\":\"PC_Open\",\"BuySellCode\":\"Buy\",\"Quantity\":{\"lo\":\"1000000\",\"signScale\":12},\"StopPrice\":{},\"Symbol\":\"AAPL  240927C00235000\",\"SchwabSecurityID\":\"101968678\",\"SolicitedCode\":\"Unsolicited\",\"AccountingRuleCode\":\"Cash\",\"SettlementType\":\"SettlementType_Regular\",\"OrderCreatedUserID\":\"O1XX\",\"OrderCreatedUserType\":\"Venue\",\"ClientProductCode\":\"N1\"}}}}","seq":114,"key":"Account Activity"}]}'

    ]
    
    for message in testList:
        # Extract the JSON part by removing the timestamp
        my_handler(message)